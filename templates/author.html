{% extends "base.html" %}

{% block title %}Author Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Author Dashboard</h1>
        <p class="text-gray-600 mt-2">Manage configuration data and AI edits</p>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-8">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button class="tab-button border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        data-tab="uploads">
                    Uploads
                </button>
                <button class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        data-tab="ai-edit">
                    AI Edit
                </button>
                <button class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                        data-tab="status">
                    Data Status
                </button>
            </nav>
        </div>

        <div id="tab-uploads" class="tab-content p-6">
            <h2 class="text-xl font-semibold mb-4">Upload Excel Files</h2>
            <p class="text-gray-600 mb-4">Upload availability, pricing, or technical data files (.xlsx format, max 10MB)</p>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                <input type="file" id="file-input" accept=".xlsx" class="hidden">
                <button onclick="document.getElementById('file-input').click()" 
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">or drag and drop</p>
            </div>

            <div id="upload-result" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-blue-900 mb-2">Upload Result</h3>
                    <div id="upload-logs"></div>
                </div>
                <div id="upload-validation"></div>
            </div>
        </div>

        <div id="tab-ai-edit" class="tab-content p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">AI Configuration Editor</h2>
            <p class="text-gray-600 mb-4">Use natural language to modify configuration data</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                <textarea id="ai-instructions" rows="4" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Example: increase base price by 500 for UK Sport Premium&#10;Example: set Panoramic Roof to O for all US trims&#10;Example: decrease Premium Audio price by 50 for EU Base"></textarea>
            </div>

            <div class="flex space-x-4 mb-4">
                <button id="preview-btn" 
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    Preview Changes
                </button>
                <button id="apply-save-btn" 
                        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition hidden">
                    Apply & Save
                </button>
                <button id="discard-btn" 
                        class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition hidden">
                    Discard
                </button>
            </div>

            <div id="ai-result" class="hidden">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-2">Changes Preview</h3>
                    <div id="ai-diff" class="font-mono text-sm"></div>
                </div>
            </div>
        </div>

        <div id="tab-status" class="tab-content p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Data Status</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-blue-50 rounded-lg p-6">
                    <h3 class="text-sm font-medium text-blue-900 mb-2">Markets</h3>
                    <p class="text-3xl font-bold text-blue-600">{{ stats.get('markets', 0) }}</p>
                </div>
                <div class="bg-green-50 rounded-lg p-6">
                    <h3 class="text-sm font-medium text-green-900 mb-2">Total Vehicles</h3>
                    <p class="text-3xl font-bold text-green-600">{{ stats.get('total_vehicles', 0) }}</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-6">
                    <h3 class="text-sm font-medium text-purple-900 mb-2">Total Features</h3>
                    <p class="text-3xl font-bold text-purple-600">{{ stats.get('total_features', 0) }}</p>
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="font-semibold mb-2">Metadata</h3>
                <dl class="grid grid-cols-1 gap-2">
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Last Updated:</dt>
                        <dd class="font-medium">{{ metadata.get('lastUpdated', 'Never') | format_datetime }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Version:</dt>
                        <dd class="font-medium">{{ metadata.get('version', 'N/A') }}</dd>
                    </div>
                </dl>
            </div>

            <button id="refresh-status-btn" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Refresh Status
            </button>

            <div id="status-validation" class="mt-6"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const tabName = button.dataset.tab;
        
        tabButtons.forEach(btn => {
            btn.classList.remove('border-blue-500', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-gray-500');
        });
        
        button.classList.remove('border-transparent', 'text-gray-500');
        button.classList.add('border-blue-500', 'text-blue-600');
        
        tabContents.forEach(content => {
            content.classList.add('hidden');
        });
        
        document.getElementById('tab-' + tabName).classList.remove('hidden');
    });
});

document.getElementById('file-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/author/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        const resultDiv = document.getElementById('upload-result');
        const logsDiv = document.getElementById('upload-logs');
        const validationDiv = document.getElementById('upload-validation');
        
        resultDiv.classList.remove('hidden');
        
        if (result.success) {
            logsDiv.innerHTML = result.logs.map(log => `<p class="text-sm text-blue-900">${log}</p>`).join('');
            
            if (result.validation) {
                const warnings = result.validation.warnings || [];
                const errors = result.validation.errors || [];
                
                if (warnings.length > 0 || errors.length > 0) {
                    validationDiv.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h3 class="font-semibold text-yellow-900 mb-2">Validation Warnings</h3>
                            ${warnings.map(w => `<p class="text-sm text-yellow-800">⚠ ${w}</p>`).join('')}
                            ${errors.map(e => `<p class="text-sm text-red-800">❌ ${e}</p>`).join('')}
                        </div>
                    `;
                } else {
                    validationDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-sm text-green-800">✓ All validations passed</p>
                        </div>
                    `;
                }
            }
        } else {
            logsDiv.innerHTML = `<p class="text-sm text-red-900">Error: ${result.error}</p>`;
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
    }
});

document.getElementById('preview-btn').addEventListener('click', async () => {
    const instructions = document.getElementById('ai-instructions').value;
    if (!instructions.trim()) {
        alert('Please enter instructions');
        return;
    }
    
    try {
        const response = await fetch('/api/author/ai-edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instructions })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const diffDiv = document.getElementById('ai-diff');
            const changes = result.changes || result.diff || [];
            
            diffDiv.innerHTML = changes.map(change => {
                let color = 'text-gray-700';
                if (typeof change === 'string') {
                    if (change.startsWith('+')) color = 'text-green-700';
                    else if (change.startsWith('-')) color = 'text-red-700';
                    else if (change.startsWith('~')) color = 'text-blue-700';
                }
                return `<div class="${color}">${change}</div>`;
            }).join('');
            
            document.getElementById('ai-result').classList.remove('hidden');
            document.getElementById('apply-save-btn').classList.remove('hidden');
            document.getElementById('discard-btn').classList.remove('hidden');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('AI Edit error:', error);
        alert('Failed to preview changes: ' + error.message);
    }
});

document.getElementById('apply-save-btn').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/author/save', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Changes saved successfully!');
            document.getElementById('ai-instructions').value = '';
            document.getElementById('ai-result').classList.add('hidden');
            document.getElementById('apply-save-btn').classList.add('hidden');
            document.getElementById('discard-btn').classList.add('hidden');
        } else {
            alert('Error saving: ' + result.error);
        }
    } catch (error) {
        alert('Failed to save: ' + error.message);
    }
});

document.getElementById('discard-btn').addEventListener('click', async () => {
    try {
        await fetch('/api/author/discard', { method: 'POST' });
        document.getElementById('ai-result').classList.add('hidden');
        document.getElementById('apply-save-btn').classList.add('hidden');
        document.getElementById('discard-btn').classList.add('hidden');
        alert('Changes discarded');
    } catch (error) {
        console.error('Discard error:', error);
    }
});

document.getElementById('refresh-status-btn').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/author/status');
        const data = await response.json();
        
        const validationDiv = document.getElementById('status-validation');
        
        if (data.validation) {
            const warnings = data.validation.warnings || [];
            const errors = data.validation.errors || [];
            
            if (warnings.length > 0 || errors.length > 0) {
                validationDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="font-semibold text-yellow-900 mb-2">Validation Issues</h3>
                        ${warnings.map(w => `<p class="text-sm text-yellow-800">⚠ ${w}</p>`).join('')}
                        ${errors.map(e => `<p class="text-sm text-red-800">❌ ${e}</p>`).join('')}
                    </div>
                `;
            } else {
                validationDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-green-800">✓ All validations passed</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Status refresh error:', error);
    }
});
</script>
{% endblock %}
